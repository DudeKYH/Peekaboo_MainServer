{
  "version": 3,
  "sources": ["../../src/events/onC2G.event.js"],
  "sourcesContent": ["import config from '@peekaboo-ssr/config/gateway';\r\nimport BaseEvent from '@peekaboo-ssr/events/BaseEvent';\r\nimport { routeG2SHandler } from '../utils/routes/packet.routes.js';\r\nimport { connectSessions } from '../sessions/sessions.js';\r\n\r\nclass C2GEventHandler extends BaseEvent {\r\n  onConnection(socket) {\r\n    console.log(\r\n      `Game Client connected from: ${socket.remoteAddress}:${socket.remotePort}`,\r\n    );\r\n    connectSessions.push({\r\n      remote: `${socket.remoteAddress}:${socket.remotePort}`,\r\n      socket: socket,\r\n      sequence: 1,\r\n    });\r\n    socket.buffer = Buffer.alloc(0);\r\n  }\r\n\r\n  // \uAC8C\uC774\uD2B8\uC6E8\uC774\uC5D0\uC11C\uB294 \uD5E4\uB354 \uAC80\uC99D \uBC0F \uB77C\uC6B0\uD305\uAE4C\uC9C0\uB9CC \uC218\uD589.\r\n  // \uB77C\uC6B0\uD305 \uC2DC \uC5B4\uB5A4 \uC720\uC800\uAC00 \uBCF4\uB0B8\uAC74\uC9C0 \uC800\uC7A5\uD558\uC5EC \uC218\uD589\uD558\uB3C4\uB85D \uD568.\r\n  onData(socket, data) {\r\n    socket.buffer = Buffer.concat([socket.buffer, data]);\r\n\r\n    while (\r\n      socket.buffer.length >=\r\n      config.header.client.typeLength + config.header.client.versionLength\r\n    ) {\r\n      let offset = 0;\r\n      const packetType = socket.buffer.readUint16BE(offset);\r\n      offset += config.header.client.typeLength;\r\n\r\n      const versionLength = socket.buffer.readUint8(offset);\r\n      offset += config.header.client.versionLength;\r\n\r\n      const totalHeaderLength =\r\n        config.header.client.typeLength +\r\n        config.header.client.versionLength +\r\n        versionLength +\r\n        config.header.client.sequenceLength +\r\n        config.header.client.payloadLength;\r\n\r\n      if (socket.buffer.length < totalHeaderLength) {\r\n        break;\r\n      }\r\n\r\n      const version = socket.buffer\r\n        .subarray(offset, offset + versionLength)\r\n        .toString('utf-8');\r\n      offset += versionLength;\r\n\r\n      if (version !== config.version) {\r\n        console.error(`\uBC84\uC804 \uC5D0\uB7EC: ${version}`);\r\n      }\r\n\r\n      const sequence = socket.buffer.readUint32BE(offset);\r\n      offset += config.header.client.sequenceLength;\r\n\r\n      const payloadLength = socket.buffer.readUint32BE(offset);\r\n      offset += config.header.client.payloadLength;\r\n\r\n      const totalPacketLength = totalHeaderLength + payloadLength;\r\n      if (socket.buffer.length < totalPacketLength) {\r\n        break;\r\n      } else {\r\n        const payloadBuffer = socket.buffer.subarray(\r\n          offset,\r\n          offset + payloadLength,\r\n        );\r\n        offset += payloadLength;\r\n        try {\r\n          socket.buffer = socket.buffer.subarray(offset);\r\n          routeG2SHandler(socket, packetType, payloadLength, payloadBuffer);\r\n        } catch (e) {\r\n          console.error(e);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  onEnd(socket) {\r\n    console.log('Client Disconnected', socket.remoteAddress, socket.remotePort);\r\n  }\r\n\r\n  onError(socket, err) {\r\n    console.log('Client Disconnected', socket.remoteAddress, socket.remotePort);\r\n  }\r\n}\r\n\r\nexport default C2GEventHandler;\r\n"],
  "mappings": "AAAA,OAAO,YAAY;AACnB,OAAO,eAAe;AACtB,SAAS,uBAAuB;AAChC,SAAS,uBAAuB;AAEhC,MAAM,wBAAwB,UAAU;AAAA,EACtC,aAAa,QAAQ;AACnB,YAAQ;AAAA,MACN,+BAA+B,OAAO,aAAa,IAAI,OAAO,UAAU;AAAA,IAC1E;AACA,oBAAgB,KAAK;AAAA,MACnB,QAAQ,GAAG,OAAO,aAAa,IAAI,OAAO,UAAU;AAAA,MACpD;AAAA,MACA,UAAU;AAAA,IACZ,CAAC;AACD,WAAO,SAAS,OAAO,MAAM,CAAC;AAAA,EAChC;AAAA;AAAA;AAAA,EAIA,OAAO,QAAQ,MAAM;AACnB,WAAO,SAAS,OAAO,OAAO,CAAC,OAAO,QAAQ,IAAI,CAAC;AAEnD,WACE,OAAO,OAAO,UACd,OAAO,OAAO,OAAO,aAAa,OAAO,OAAO,OAAO,eACvD;AACA,UAAI,SAAS;AACb,YAAM,aAAa,OAAO,OAAO,aAAa,MAAM;AACpD,gBAAU,OAAO,OAAO,OAAO;AAE/B,YAAM,gBAAgB,OAAO,OAAO,UAAU,MAAM;AACpD,gBAAU,OAAO,OAAO,OAAO;AAE/B,YAAM,oBACJ,OAAO,OAAO,OAAO,aACrB,OAAO,OAAO,OAAO,gBACrB,gBACA,OAAO,OAAO,OAAO,iBACrB,OAAO,OAAO,OAAO;AAEvB,UAAI,OAAO,OAAO,SAAS,mBAAmB;AAC5C;AAAA,MACF;AAEA,YAAM,UAAU,OAAO,OACpB,SAAS,QAAQ,SAAS,aAAa,EACvC,SAAS,OAAO;AACnB,gBAAU;AAEV,UAAI,YAAY,OAAO,SAAS;AAC9B,gBAAQ,MAAM,8BAAU,OAAO,EAAE;AAAA,MACnC;AAEA,YAAM,WAAW,OAAO,OAAO,aAAa,MAAM;AAClD,gBAAU,OAAO,OAAO,OAAO;AAE/B,YAAM,gBAAgB,OAAO,OAAO,aAAa,MAAM;AACvD,gBAAU,OAAO,OAAO,OAAO;AAE/B,YAAM,oBAAoB,oBAAoB;AAC9C,UAAI,OAAO,OAAO,SAAS,mBAAmB;AAC5C;AAAA,MACF,OAAO;AACL,cAAM,gBAAgB,OAAO,OAAO;AAAA,UAClC;AAAA,UACA,SAAS;AAAA,QACX;AACA,kBAAU;AACV,YAAI;AACF,iBAAO,SAAS,OAAO,OAAO,SAAS,MAAM;AAC7C,0BAAgB,QAAQ,YAAY,eAAe,aAAa;AAAA,QAClE,SAAS,GAAG;AACV,kBAAQ,MAAM,CAAC;AAAA,QACjB;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAAA,EAEA,MAAM,QAAQ;AACZ,YAAQ,IAAI,uBAAuB,OAAO,eAAe,OAAO,UAAU;AAAA,EAC5E;AAAA,EAEA,QAAQ,QAAQ,KAAK;AACnB,YAAQ,IAAI,uBAAuB,OAAO,eAAe,OAAO,UAAU;AAAA,EAC5E;AACF;AAEA,IAAO,sBAAQ;",
  "names": []
}
